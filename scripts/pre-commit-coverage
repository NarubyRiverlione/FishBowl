#!/bin/sh
#
# Pre-commit hook to update coverage badges in README.md
# 
# This hook runs before each commit and automatically updates
# the coverage badges if coverage data exists.
#
# To install: cp scripts/pre-commit-coverage .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}ðŸ” Checking for coverage updates...${NC}"

# Check if coverage data exists
if [ ! -f "coverage/coverage-final.json" ]; then
    echo "${YELLOW}âš ï¸  No coverage data found. Skipping badge update.${NC}"
    echo "${YELLOW}ðŸ’¡ Run 'pnpm test:coverage' to generate coverage data${NC}"
    exit 0
fi

# Check if the update script exists
if [ ! -f "scripts/update-coverage-badges.js" ]; then
    echo "${YELLOW}âš ï¸  Coverage badge update script not found. Skipping.${NC}"
    exit 0
fi

# Update coverage badges
echo "${BLUE}ðŸ“Š Updating coverage badges...${NC}"
node scripts/update-coverage-badges.js

# Check if README.md was modified
if git diff --exit-code README.md >/dev/null 2>&1; then
    echo "${GREEN}âœ… Coverage badges are up to date${NC}"
else
    echo "${GREEN}ðŸ“Š Coverage badges updated in README.md${NC}"
    
    # Stage the updated README.md
    git add README.md
    echo "${GREEN}âœ… README.md staged for commit${NC}"
fi

echo "${GREEN}ðŸŽ‰ Pre-commit coverage check complete${NC}"
exit 0